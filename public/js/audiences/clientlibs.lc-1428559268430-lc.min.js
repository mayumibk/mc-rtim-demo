$(function(){AL.SegmentListSelector=AL.SegmentListSelector||{};
var a=$(".audience-list-widget").attr("mode")==="single",c=null,d=$("#select-all-checkbox"),b=$(".segmentList");
AL.SegmentListSelector.updateAllCheckboxes=function(){var e=d.is(":checked");
$(".list").find(".item-checkbox").each(function(f,g){e?AL.SegmentListSelector.selectItem($(g)):AL.SegmentListSelector.unselectItem($(g))
});
AL.SegmentListSelector.updateActionbar()
};
AL.SegmentListSelector.selectItem=function(e){if(a&&c){c.removeAttr("checked");
c.parents(".listItem").removeClass("selected")
}e.attr("checked","checked");
e.parents(".listItem").addClass("selected");
if(a){c=e;
$(".audience-selector-done").removeClass("disabled")
}};
AL.SegmentListSelector.unselectItem=function(f){var e=$(".list").find(".item-checkbox:checked").length;
f.removeAttr("checked","checked");
f.parents(".listItem").removeClass("selected");
if(a){c=null
}if(e===0){$(".audience-selector-done").addClass("disabled")
}};
AL.SegmentListSelector.updateListItemAndActionbar=function(){var e=$(this);
e.is(":checked")?AL.SegmentListSelector.selectItem(e):AL.SegmentListSelector.unselectItem(e);
AL.SegmentListSelector.updateActionbar()
};
AL.SegmentListSelector.updateActionbar=function(){var f=$(".list").find(".item-checkbox:checked").length,i=$(".actionBar");
i.removeClass("item-selected activate deactivate disableActivate");
if(f>0){i.addClass("item-selected");
var g=$(".list").find(".item-checkbox:checked").parent().siblings(".active").length;
var e=$(".list").find(".item-checkbox:checked").parent().siblings(".inactive").length;
var h=g==f?"deactivate":(e==f?"activate":"disableActivate");
i.addClass(h)
}};
AL.SegmentListSelector.getSelectedItems=function(){return b.find("li.selected")
};
AL.SegmentListSelector.postSelectedItemEvent=function(g){var f=parent,i=$(g.target).data("action"),j={config:{action:i}},k=AL.SegmentListSelector.getSelectedItems(),h=new Array(),e=document.location.origin;
if(window.opener){f=window.opener
}if(i==="done"){k.map(function(){var l=new Object();
l.id=$(this).data("segmentid");
l.title=$(".title ",$(this)).text().trim();
l.url=e+$(this).data("path");
l.segmentRule=$(this).data("rule");
h.push(l)
});
j.data=h
}f.postMessage(JSON.stringify(j),$(".audience-list-widget").data("targetorigin"))
};
$(document).on("change","#select-all-checkbox",AL.SegmentListSelector.updateAllCheckboxes);
$(document).on("change",".list .item-checkbox",AL.SegmentListSelector.updateListItemAndActionbar);
$(".audience-selector-clear").click(AL.SegmentListSelector.postSelectedItemEvent);
$(".audience-selector-done").click(AL.SegmentListSelector.postSelectedItemEvent)
});
$(function(){$(".search-by").click(d);
$(".searchField").keyup(a);
$(".column-name input").change(c);
var b=null;
function a(){if(b!=null){clearTimeout(b)
}b=setTimeout(e,2000)
}function d(){var g=$(".searchField"),h=$(this).attr("data-searchkey"),f=$(this).attr("data-key");
$("#search-popover-point").trigger("click");
g.attr("data-key",f).val(h).focus()
}function e(){var g=$(".searchField"),f=$(".segment-count.badge"),k=$(".audience-list-widget").data("searchpath"),l=$(".audience-list-widget").attr("source-id"),i=$(".segmentList"),h=g.attr("data-key")||"all",j=g.val();
AL.resetPageForCurrentConfiguration();
AL.disableSortingPreference();
if(j===""){AL.enableSortingPreference();
AL.loadNextPage()
}else{j=j.split(":");
if(j.length>1){j=j[1].trim().toLowerCase()
}else{j=j[0].trim().toLowerCase()
}$(".load-segments").removeClass("al-hidden");
$(".waitContainer").removeClass("al-hidden");
$(".load-segments .load-more").addClass("al-hidden");
i.empty();
f.text(0);
$.ajax({url:k,data:{searchKey:h,searchValue:j,_charset_:"utf-8",dataSource:l},contentType:"json",dataType:"text"}).done(function(m){i.html(m)
}).fail(function(m){$("#error-segmentList-modal").show().find(".message").html(Granite.I18n.get("Logged in user does not have appropriate permissions to view audiences. Please contact System Administrator to get permissions.",null,"AL: "))
}).always(function(){$(".load-segments").addClass("al-hidden");
$(".waitContainer").addClass("al-hidden");
f.text($(".listItem",i).length)
})
}}function c(){var g=$(this),f=g.attr("data-target"),j=g.is(":checked"),i=$(".content").find("."+f);
j?i.show():i.hide();
if(f=="active"){var h=$(".content").find(".inactive");
j?h.show():h.hide()
}}});
$(function(){var g=$("#actionBar"),i=$(".audience-list-widget").attr("source-id"),b=$(".waitContainer"),h=AL._tenantHome+"/audiences/folder";
g.find("#create-segment").click(c);
g.find(".segmentName").on("focus",a);
g.find(".action-delete").click(d);
g.find(".action-copy").click(j);
g.find(".action-update-activate").click(function(){l("active")
});
g.find(".action-update-deactivate").click(function(){l("inactive")
});
function a(m){$(m.target).removeClass("error")
}function c(){var m=g.find(".segmentName"),n=m.val().trim();
m.removeClass("error");
if(n){b.removeClass("al-hidden");
$.ajax({url:h,type:"POST",data:{action:"create_trait_segment_pair",data:JSON.stringify({name:n,dataSourceId:i})}}).done(function(p){var o=p&&p.messages;
if(o&&o.length>0&&o[0].type=="error"){$("#error-segmentList-modal").show().find(".message").html(o[0].content)
}else{window.location.reload()
}}).fail(function(){console.error("Failed to create segment")
}).always(function(){b.addClass("al-hidden")
})
}else{m.addClass("error")
}}function d(){var n=AL.SegmentListSelector.getSelectedItems(),m=[];
$.each(n,function(o,p){m.push(p.getAttribute("data-path"))
});
if(m.length!=0){f(m.length,function(){b.removeClass("al-hidden");
$.ajax({url:h,type:"POST",data:{action:"delete",data:JSON.stringify({paths:m})}}).done(function(p){var o=p&&p.messages;
if(o&&o.length>0&&o[0].type=="error"){$("#error-segmentList-modal").show().find(".message").html(o[0].content)
}else{k(n)
}AL.SegmentListSelector.updateActionbar()
}).fail(function(){console.error("Failed to delete segments")
}).always(function(){b.addClass("al-hidden");
$(".segment-count.badge").text($(".listItem",$(".segmentList")).length)
})
})
}}function j(){var n=AL.SegmentListSelector.getSelectedItems(),m=[];
$.each(n,function(o,p){m.push(p.getAttribute("data-path"))
});
if(m.length==1){b.removeClass("al-hidden");
window.location.href=m[0].replace("/audiencelibrary","/audiences/details.copy.html")
}else{e()
}}function l(m){var o=AL.SegmentListSelector.getSelectedItems(),n=[];
$.each(o,function(p,q){n.push(q.getAttribute("data-path"))
});
if(n.length!=0){b.removeClass("al-hidden");
$.ajax({url:h,type:"POST",data:{action:"update_audience_state",data:JSON.stringify({paths:n,status:m})}}).done(function(q){var p=q&&q.messages;
if(p&&p.length>0&&p[0].type=="error"){$("#error-segmentList-modal").show().find(".message").html(p[0].content)
}location.reload()
}).fail(function(){console.error("Failed to update segment")
}).always(function(){b.addClass("al-hidden")
})
}}function k(m){m.remove()
}function f(n,p){var m=$("#confirm-delete-modal"),o="<p>"+Granite.I18n.get("Are you sure you want to delete {0} audiences ?",n,"AL: The variable is the number of audiences that user is deleted")+"</p>";
m.modal({type:"notice",header:Granite.I18n.get("Confirm Delete",null,"AL: "),content:o,buttons:[{label:Granite.I18n.get("Cancel",null,"AL: "),click:"hide"},{label:Granite.I18n.get("Delete",null,"AL: "),className:"primary",click:function(){this.hide();
typeof p=="function"&&p()
}}]});
m.modal("show")
}function e(){var m=$("#warn-copy-modal"),n="<p>"+Granite.I18n.get("You cannot copy more than one audience",null,"AL: Warning message for copying more than one audience")+"</p>";
m.modal({type:"error",header:Granite.I18n.get("Warning",null,"AL: "),content:n,buttons:[{label:Granite.I18n.get("Ok",null,"AL: "),click:"hide"}]});
m.modal("show")
}});
$(function(){AL.disableSortingPreference=function(){$(".segment-sortorder .icon").unbind("click",a);
$(".segment-sortorder").addClass("al-hidden");
$(".segment-count.badge").addClass("al-hidden")
};
AL.enableSortingPreference=function(){$(".segment-sortorder .icon").bind("click",a);
$(".segment-sortorder").removeClass("al-hidden");
$(".segment-count.badge").removeClass("al-hidden")
};
function b(g){var d=$(this).parents(".listItem"),f=d.attr("data-path"),c=$(".waitContainer");
if(f){c.removeClass("al-hidden");
window.location.href=f+".edit.html"
}return false
}function a(){var c=$(".segment-sortorder .icon.selected"),d=$(".segment-sortorder .icon.al-hidden");
c.removeClass("selected").addClass("al-hidden");
d.addClass("selected").removeClass("al-hidden");
AL.toggleLastModifiedSortOrder();
AL.loadNextPage();
return false
}$(document).on("click",".segmentList .macSegment",b);
$(".segment-sortorder .icon").bind("click",a)
});
$(function(){var a=$(".audience-list-widget").attr("source-id"),c="updateTime",e={ASC:0,DESC:1},i={lastModifiedSortOrder:e.DESC,currentViewPage:0,SCROLL_THRESHOLD:30},m=location.pathname.match(".*?.html(.*)$")[1],g="audiences.html/audiencelibrary"+m;
g+=".fulllist.html?ck="+new Date().getMilliseconds();
if(a){g+="&dataSource="+a
}AL=AL||{};
AL.resetPageForCurrentConfiguration=function(){i.currentViewPage=0
};
AL.toggleLastModifiedSortOrder=function(){i.currentViewPage=0;
(i.lastModifiedSortOrder==e.ASC)?i.lastModifiedSortOrder=e.DESC:i.lastModifiedSortOrder=e.ASC
};
AL.loadNextPage=function(){var o={action:"get_audiences",page:i.currentViewPage,sortBy:c,descending:i.lastModifiedSortOrder==e.DESC},n=$(".segmentList");
mode=n.data("mode");
if(i.isPageLoading){return
}i.isPageLoading=true;
$(".load-segments").removeClass("al-hidden");
$(".waitContainer").removeClass("al-hidden");
$(".load-segments .load-more").addClass("al-hidden");
if(i.currentViewPage===0){$(".segmentList").empty();
$(".segment-count.badge").text(0)
}$.get(g+(mode==="audienceselector"?"&mode=audienceselector":""),o,null,"html").done(function(p){if(!k(p)){p=f(p);
if(p&&p.length>0){n.append(p);
d();
j();
i.currentViewPage++;
h()
}else{b()
}}else{l(p)
}}).fail(function(p){l(p)
}).always(function(){i.isPageLoading=false;
$(".waitContainer").addClass("al-hidden");
$(".load-segments .load-more").removeClass("al-hidden");
$(".segment-count.badge").text($(".listItem",n).length)
})
};
function h(){var n=$(".load-segments");
if(n.hasClass("al-hidden")){n.removeClass("al-hidden")
}n.click(AL.loadNextPage)
}function b(){var n=$(".load-segments");
n.addClass("al-hidden")
}AL.loadNextPage();
function d(){var n=$(".segment-filters-placeholder").find(".column-name");
$.each(n,function(p,o){var q=$(o).find("input"),u=q.is(":checked"),t=q.attr("data-target"),s=$(".content").find("."+t);
u?s.show():s.hide();
if(t=="active"){var r=$(".content").find(".inactive");
u?r.show():r.hide()
}})
}function l(n){$("#error-segmentList-modal").show().find(".message").html(Granite.I18n.get("Logged in user does not have appropriate permissions to view audiences. Please contact System Administrator to get permissions.",null,"AL: "));
b()
}function k(o){if(o!=null&&typeof o==="string"&&o.charAt(0)==="{"&&o.charAt(o.length-1)==="}"){var n=JSON.parse(o);
return !n.success
}return false
}function f(p){var n=$(".segmentList li"),o,q;
if(n.length>0){o=$.map(n,function(r){return $(r).data("path")
});
q=$(p).filter(function(){var r=$(this).data("path");
if(r&&o.indexOf(r)===-1){return true
}});
return $("<div>").html(q).html()
}return p
}function j(){$(".segmentList li .wait").each(function(){var o=$(this).parent(),n=$(this).closest("li").data("path");
if(n){$.getJSON(n+".size.json").done(function(p){if(p){o.html(p.size)
}}).always(function(){if(o.find(".wait").size()>0){o.html("<i class='icon-alert'></i>")
}})
}})
}});