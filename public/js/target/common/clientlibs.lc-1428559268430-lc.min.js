var ELM=ELM||{};
ELM.UI=ELM.UI||{};
ELM.ItemFactory=function(a){this.items=[];
this.itemsFetched=false;
this.disableCache=false;
this.disableFactory=false;
this.url=a.url;
this.pageSize=a.pageSize;
this.factoryName=a.name;
if(a.parse){this.parse=a.parse
}if(typeof a.disableCache!=="undefined"){this.disableCache=a.disableCache
}if(a.disable){this.disable()
}if(a.fetch){this.fetchItems()
}};
ELM.ItemFactory.prototype.toString=function(){return this.factoryName
};
ELM.ItemFactory.prototype.isDisabled=function(){return this.disableFactory
};
ELM.ItemFactory.prototype.disable=function(){this.disableFactory=true
};
ELM.ItemFactory.prototype.enable=function(){this.disableFactory=false
};
_getItemsInDisabledState=function(a){if(typeof a==="function"){a.call("undefined",[])
}};
ELM.ItemFactory.prototype.getItems=function(a){if(this.isDisabled()){return _getItemsInDisabledState(a.callback)
}if(this.itemsFetched){if(typeof a.callback==="function"){a.callback.call(undefined,this.items)
}}else{this.fetchItems(a)
}};
ELM.ItemFactory.prototype.buildUrl=function(a,b){b=b||"";
if(this.pageSize){b+=(!b?"":"&")+("pageSize="+this.pageSize)
}return b?(a+(a.indexOf("?")!==-1?"&":"?")+b):a
};
ELM.ItemFactory.prototype.fetchItems=function(b){if(this.isDisabled()){return _getItemsInDisabledState(b.callback)
}var c=this,a=this.url;
b=b||{};
$.ajax({url:this.buildUrl(a,b.params),async:b.hasOwnProperty("async")?b.async:true,contentType:"application/json; charset=utf-8",dataType:"json"}).done(function(d){if(!c.disableCache){c.itemsFetched=true
}c.items=c.parse(d);
if(typeof b.callback==="function"){b.callback.call(undefined,c.items)
}}).fail(function(){if(typeof b.callback==="function"){b.callback.call(undefined,c.items)
}})
};
ELM.ItemFactory.prototype.parse=function(a){return a.items||[]
};
ELM.ItemFactory.prototype.setUrl=function(a){this.url=a
};
ELM.UI.CollapsibleContainer=Class({toString:"CollapsibleContainer",defaults:{expandText:Granite.I18n.get("Expand"),collapseText:Granite.I18n.get("Collapse"),expanded:false,collapsibleSection:".collapsible-section",animation:true,animationDuration:500},construct:function(a){this._init(a);
this._bindListeners()
},_init:function(a){this.$el=$(a.el);
this.options=$.extend({},this.defaults,this.$el.data(),a);
this.$el.append(this.linkTemplate);
this.$link=this.$el.children(".elm-action-link");
this.$icon=this.$link.children("i");
this.$text=this.$link.children("span");
this.$collapsibleSection=this.$el.find(this.options.collapsibleSection);
if(this.$collapsibleSection.length===0){this.$collapsibleSection=this.$el.children().not(this.$link)
}this.updateContainer(this.isExpanded());
this.initialized=true
},_bindListeners:function(){var a=this;
this.$link.on("click",function(){a.updateContainer(!a.isExpanded())
})
},linkTemplate:['<div class="elm-action-link padding-0-5 cursor-pointer border-top">','<i class="padding-r-0-5"></i>',"<span></span>","</div>"].join(""),updateContainer:function(a){if(typeof a!=="undefined"){this._setExpanded(a)
}this.isExpanded()?this._expand():this._collapse()
},_expand:function(){this.$collapsibleSection.show(this.initialized&&this.options.animation&&this.options.animationDuration);
this.$icon.removeClass("icon-chevrondown").addClass("icon-chevronup");
this.$text.text(this.options.collapseText);
this.$el.trigger("expanded")
},_collapse:function(){this.$collapsibleSection.hide(this.initialized&&this.options.animation&&this.options.animationDuration);
this.$icon.removeClass("icon-chevronup").addClass("icon-chevrondown");
this.$text.text(this.options.expandText);
this.$el.trigger("collapsed")
},_setExpanded:function(a){this.options.expanded=a;
this.$el.data("expanded",a)
},isExpanded:function(){return this.options.expanded
}});
ELM.UI.Components={"collapsible-container":ELM.UI.CollapsibleContainer};
$.fn.elmInit=function(a){this.each(function(){var d=$(this),b=d.data("init"),c=ELM.UI.Components[b];
if(c){a=$.extend({},a,{el:d});
new c(a)
}});
return this
};
ELM.Recommendation=ELM.Recommendation||{};
ELM.Recommendation.Util={MAXIMUM_OFFER_LENGTH:250000,MAXIMUM_RECS_TEMPLATE_LENGTH:65000,ERROR_MESSAGES:{"412":Granite.I18n.get("An Offer with the same name already exists."),"500":Granite.I18n.get("Internal Server Error"),HTML_OFFER:{EMPTY_NAME:Granite.I18n.get("The Offer name cannot be empty"),INVALID_NAME:Granite.I18n.get('An Offer name cannot contain /:*?#"<>|[]}'),EMPTY_CODE:Granite.I18n.get("The Offer HTML code cannot be empty"),CODE_LEN_EXCEEDED:Granite.I18n.get("The Offer HTML code cannot be more than 250000 characters")},RECS_TEMPLATE:{EMPTY_NAME:Granite.I18n.get("Template name cannot be empty"),EMPTY_CODE:Granite.I18n.get("Template code cannot be empty"),INVALID_VARIABLES:Granite.I18n.get("Failed to parse template code. Invalid reference: "),INVALID_CONTENT:Granite.I18n.get("Template code should have atleast one entity."),VALIDATION_FAILED:Granite.I18n.get("Failed to fetch entity attributes to validate the template content."),INVALID_NAME:Granite.I18n.get('Template name cannot contain /:*?#"<>|[]}'),CODE_LEN_EXCEEDED:Granite.I18n.get("Template code cannot be more than 65000 characters.")}},PRODUCT_ATTR_MAP:{name:{id:"name",title:Granite.I18n.get("Name"),cssClass:"ellipsis-text width-25"},message:{id:"message",title:Granite.I18n.get("Message"),cssClass:"ellipsis-text width-10"},thumbnailUrl:{id:"thumbnailUrl",title:Granite.I18n.get("ThumbnailURL"),cssClass:"ellipsis-text width-10"},id:{id:"id",title:Granite.I18n.get("ID"),cssClass:"ellipsis-text min-width-4 width-10"},host:{id:"host",title:Granite.I18n.get("Host"),cssClass:"ellipsis-text width-5"},value:{id:"value",title:Granite.I18n.get("Value"),cssClass:"ellipsis-text width-5"},inventory:{id:"inventory",title:Granite.I18n.get("Inventory"),cssClass:"ellipsis-text width-5"},lastUpdateTime:{id:"lastUpdateTime",title:Granite.I18n.get("Last Updated"),cssClass:"ellipsis-text width-10"},environment:{id:"environment",title:Granite.I18n.get("Environment"),cssClass:"ellipsis-text min-width-6 width-7"},category:{id:"category",title:Granite.I18n.get("Category"),cssClass:"ellipsis-text width-10"},pageUrl:{id:"pageUrl",title:Granite.I18n.get("PageURL"),cssClass:"ellipsis-text width-10"},brand:{id:"brand",title:Granite.I18n.get("Brand"),cssClass:"ellipsis-text width-10"},margin:{id:"margin",title:Granite.I18n.get("Margin"),cssClass:"ellipsis-text width-10"}},SEARCH_DEFAULT_ACTIVE_COLUMNS:["id","name","message","category","brand"],getProductEntityAttribute:function(b){var a={id:b,title:b.charAt(0).toUpperCase()+b.slice(1).toLowerCase(),cssClass:"ellipsis-text width-10"};
return ELM.Recommendation.Util.PRODUCT_ATTR_MAP[b]||a
},getProductSearchModel:function(a){var b={columns:[],activeColumns:[]};
_.each(a,function(c){var d=c["jcr:title"];
if(d==="categories"){d="category"
}if(c.isPredefined){b.activeColumns.push(d)
}b.columns.push({id:d})
});
if(!_.isEmpty(ELM.cachedSearchColumnSettings)){b.activeColumns=ELM.cachedSearchColumnSettings
}return b
},getOperandsFromInputString:function(a){if(!a){return[]
}return _.isArray(a)?a:ELM.Util.trimArrayValues(a.split(","))
},entityVariablesFactory:function(){if(ELM.isRecsEnabled){return new ELM.ItemFactory({url:"/target/entityAttributes.at.json",pageSize:2000,name:"entityAttributeFactory",fetch:true,parse:function(a){var e=0,b,d,g,c=["id","name","message","category"],f=[];
for(b=0;
b<a.items.length;
b++){d=a.items[b];
g=c.indexOf(d.id);
if(g!==-1){f[g]=d
}else{f[c.length+e++]=d
}}return f
}})
}}(),refreshEntityAttributes:function(a){var b=$(a.targetElem).find("button");
b.attr("disabled","disabled");
b.text(Granite.I18n.get("Refreshing List..."));
ELM.Recommendation.Util.fetchEntityAttributes(a.success)
},fetchEntityAttributes:function(b){var a=[];
if(typeof this.entityVariablesFactory!=="undefined"){if(this.entityVariablesFactory.itemsFetched){this.entityVariablesFactory.getItems({callback:function(c){a=c
}})
}this.entityVariablesFactory.itemsFetched=false;
this.entityVariablesFactory.getItems({callback:function(c){if(!_.isEqual(a,c)){b.call(undefined,c)
}else{b.call()
}}})
}},validateOffer:function(a){var c=/[\\\/:*?#"<>|}\[\]]/,b=a.isRecsTemplate?this.ERROR_MESSAGES.RECS_TEMPLATE:this.ERROR_MESSAGES.HTML_OFFER;
if(!a.offerName){a.error(b.EMPTY_NAME);
return false
}if(a.offerName.match(c)){a.error(b.INVALID_NAME);
return false
}if(!$.trim(a.offerContent)){a.error(b.EMPTY_CODE);
return false
}if(a.offerContent.length>(a.isRecsTemplate?this.MAXIMUM_RECS_TEMPLATE_LENGTH:this.MAXIMUM_OFFER_LENGTH)){a.error(b.CODE_LEN_EXCEEDED);
return false
}if(a.isRecsTemplate){return ELM.Recommendation.Util.validateTemplateContent(a)
}else{a.success();
return true
}},validateTemplateContent:function(a){var b;
$.ajax({url:"/target/"+ELM.client+"/target/setup/recs.validatetemplate.at.json",type:"POST",data:{name:a.offerName,content:a.offerContent,isRecsTemplate:a.isRecsTemplate}}).done(function(c){b=c.valid;
if(b){a.success()
}else{a.error(c.messages[0].text)
}return b
}).error(function(c){a.error(JSON.parse(c.responseText)["error.message"]);
return false
})
},saveOffer:function(a){$.ajax({url:a.offerUrl,type:"POST",data:{_charset_:"utf-8",":operation":"import",":contentType":"json",":name":a.offerNodeName,":content":JSON.stringify({"jcr:primaryType":"dam:Asset","jcr:content":{"jcr:primaryType":"dam:AssetContent","cq:name":a.offerName,metadata:{"jcr:primaryType":"nt:unstructured","dc:format":"text/html","dc:title":a.offerName},related:{"jcr:primaryType":"nt:unstructured",targetRecsTemplate:a.isRecsTemplate,createdByTarget:true},renditions:{"jcr:primaryType":"nt:folder",original:{"jcr:primaryType":"nt:file","jcr:content":{"jcr:primaryType":"nt:resource","jcr:data":a.offerContent,"jcr:mimeType":"text/html"}}}}})}}).done(function(){a.success()
}).error(function(b){a.error(b)
})
},updateOffer:function(a){$.ajax({url:a.offerUrl,type:"POST",data:{_charset_:"utf-8","jcr:content/renditions/original/jcr:content/jcr:lastModified":new Date().toISOString(),"jcr:content/renditions/original/jcr:content/jcr:data":a.offerContent,"jcr:content/metadata/dc:title":a.offerName},beforeSend:function(b){b.overrideMimeType("text/html; charset=utf-8");
b.setRequestHeader("Content-Type","application/x-www-form-urlencoded;charset=utf-8")
}}).done(a.success).error(a.error)
},deleteOffer:function(a){$.ajax({url:"/target/"+ELM.client+"/target/offers.action.at.json",type:"POST",contentType:"application/json; charset=utf-8",dataType:"json",data:JSON.stringify({action:"delete",resources:[a.offerUrl]})}).done(a.success).error(a.error)
},getStarterTemplateCode:function(a){var b=$(a.target).data("alignment-type"),c=this.getTemplateStartCode(b);
a.success(c)
},getTemplateStartCode:function(a){var b=['<style type="text/css">',"  .at-table {","    display:table;","    width:auto;","    border-spacing:5px;"].join("\n");
if(a==="left"){b+="\n    float:left;\n  }\n\n"
}else{if(a==="right"){b+="\n    float:right;\n  }\n\n"
}else{b+="\n    margin:0 auto;\n  }\n\n"
}}b+=this.getTemplateCommonCSS();
b+='\n</style>\n<div class="at-table">\n  <div class="at-table-row">\n';
b+=this.getTemplateRowEntry(2,0);
b+='  </div>\n  <div class="at-table-row">\n';
b+=this.getTemplateRowEntry(2,2);
b+="  </div>\n</div>";
return b
},getTemplateRowEntry:function(a,b){var e="",d=['    <div class="at-table-column">','      <a href="$entity$ENTITY_COUNT.pageUrl">','        <img src="$entity$ENTITY_COUNT.thumbnailUrl" class="at-thumbnail"/>',"        <br/>$entity$ENTITY_COUNT.name","        <br/>$entity$ENTITY_COUNT.message","        <br/>$entity$ENTITY_COUNT.value","      </a>","    </div>\n"].join("\n");
for(var c=1;
c<=a;
c++){e+=d.replace(new RegExp("\\$ENTITY_COUNT","g"),(c+b).toString())
}return e
},getTemplateCommonCSS:function(){return["  .at-table-row {","    display:table-row;","    width:auto;","    clear:both;","    padding:10px;","  }\n","  .at-table-column {","    float:left;","    display:table-column;","    padding:10px;","  }\n","  .at-thumbnail {","    max-width: 250px;","    max-height: 250px;","  }"].join("\n")
},getAllEntityVariables:function(a){if(typeof this.entityVariablesFactory=="undefined"){return
}this.entityVariablesFactory.getItems({callback:function(f){var b,e="",d=[];
if(f.length){for(b=0;
b<f.length;
b++){if(a.includeCustom||f[b]["isPredefined"]){d.push(f[b]["jcr:title"]);
e+="<br/>entity."+f[b]["jcr:title"]+"\n"
}}a.success(d,e)
}else{if(a.error){var c=a.includeCustom?Granite.I18n.get("Failed to fetch custom entity attributes."):Granite.I18n.get("Failed to fetch entity attributes.");
a.error(c)
}}},async:a.async})
},getActiveColumns:function(b){var a=ELM.Util.clone(this.SEARCH_DEFAULT_ACTIVE_COLUMNS);
_.forEach(b,function(c){if(a.indexOf(c.attributeName)===-1){a.push(c.attributeName)
}});
return a
},getDefaultSearchEnvironment:function(b){var a,c=this;
if(b){a=this.getEnvironmentId(b.get("hostGroups"))
}else{$.ajax({url:"/target/"+ELM.client+"/target/setup/tt/hostgroups.external.at.json",async:false,contentType:"application/json; charset=utf-8",dataType:"json"}).done(function(d){a=c.getEnvironmentId(d.hostGroups)
})
}return a
},getEnvironmentId:function(b){var a;
_.each(b,function(c){if(c.isDefault){a=c.id
}});
return a
}};