crs=window.crs||{};
crs.core=crs.core||{};
var shouldRefreshToken=true;
crs.core={kWarningShowTime:5000,warningTimerObject:null,tenantID:null,$dataSourcesList:null,$waitIndicator:null,$listHeader:null,$searchDiv:null,crsAPIUrl:null,$errorModal:null,isSearchEnabled:false,dataSourcePage:{dataSourceId:null},initialize:function(){this.$dataSourcesList=$("#crs-content .datasourcesList ul");
this.$waitIndicator=$("div#waitContainer");
this.$searchDiv=$(".actionBar .search-placeholder");
this.$listHeader=$("ul li.header");
this.$errorModal=$("#error-dsList-modal");
this.$warnModal=$("#warn-dsList-modal");
var a=location.pathname.substr(location.pathname.indexOf(".html")+6);
this.tenantID=a.substr(0,a.indexOf("/"));
this.crsAPIUrl="datasources/crs/datasources";
this.fetchAllDataSources()
},fetchListCallback:function(){crs.core.fetchAllDataSources()
},fetchAllDataSources:function(e,b){var a=this.crsAPIUrl+".list.html";
var d={action:"get_datasources",descending:(b)?"true":"false"};
if(!e){e=$("ul > li div.cell.middle.name.sortable").data("sort-by")
}d.sortBy=e;
var c=this;
this.showLoading();
crs.core.$dataSourcesList.empty();
$.get(a,d).done(function(f){c.showDataSourcesList(f)
}).fail(function(f){console.error(f);
c.showErrorMessage()
}).always(function(){var g=true;
if(c.$dataSourcesList.find("li.listItem").length==0&&shouldRefreshToken){var h=$("#ds-server-error-modal .message");
var f=h.text().toLowerCase();
if(f&&(f.indexOf("token")>-1||f.indexOf("access")>-1)){$("#ds-server-error-modal").remove();
g=false;
shouldRefreshToken=false;
tartan.auth.keepAlive(crs.core.fetchListCallback)
}}if(g){c.hideLoading()
}})
},showDataSourcesList:function(b,a){if(b!=null&&b.trim()!=""){crs.core.$dataSourcesList.html(b).trigger("cui-contentloaded");
if(crs.core.$dataSourcesList.find("li.listItem").length!=0){crs.core.$listHeader.removeClass("hidden");
crs.core.isSearchEnabled=true;
$("body").trigger("coachmarks.parseAgain",["dataSourceDescription"])
}}else{}},showErrorMessage:function(a){var b=(a)?a:Granite.I18n.get("Error in retrieving attribute sources.",null,"CRS: data source == attribute source");
crs.core.$errorModal.show().find(".message").html(b)
},showWarnMessage:function(a){crs.core.hideWarnMessage();
var a=(a)?a:Granite.I18n.get("Problem in performing an operation.",null,"CRS: ");
crs.core.$warnModal.show().find(".message").html(a);
crs.core.warningTimerObject=setTimeout(crs.core.hideWarnMessage,crs.core.kWarningShowTime)
},hideWarnMessage:function(){if(crs.core.warningTimerObject!=null){clearTimeout(crs.core.warningTimerObject);
crs.core.warningTimerObject=null;
crs.core.$warnModal.hide()
}},showLoading:function(){this.$waitIndicator.removeClass("hidden")
},hideLoading:function(){this.$waitIndicator.addClass("hidden")
}};
$(document).ready(function(){$.ajaxSetup({cache:false});
$(document).on("click","ul > li .cell.sortable.sorting-enabled",function(){var a=$(this).find(".icon");
if(!a.hasClass("hidden")){a.toggleClass("icon-arrowdown");
a.toggleClass("icon-arrowup")
}else{$("ul > li .cell.sortable .icon").addClass("hidden");
a.removeClass("hidden");
a.toggleClass("icon-arrowdown");
a.toggleClass("icon-arrowup")
}crs.core.fetchAllDataSources($(this).data("sort-by"),a.hasClass("icon-arrowdown"))
});
crs.core.initialize()
});
$(function(){crs.core.toolbar={$selectAllCheckbox:$("#select-all-checkbox"),$dataSourceList:$("div.datasourcesList ul.list"),$ulList:$("#crs-content ul.list"),$actionbar:$(".actionBar"),updateAllCheckboxes:function(){var a=crs.core.toolbar.$selectAllCheckbox.is(":checked");
$(".list").find(".item-checkbox").each(function(b,c){a?crs.core.toolbar.selectItem($(c)):crs.core.toolbar.unselectItem($(c))
});
crs.core.toolbar.updateActionbar()
},selectItem:function(a){a.attr("checked","checked");
a.parents(".listItem").addClass("selected")
},unselectItem:function(a){a.removeAttr("checked","checked");
a.parents(".listItem").removeClass("selected")
},updateListItemAndActionbar:function(){var a=$(this);
a.is(":checked")?crs.core.toolbar.selectItem(a):crs.core.toolbar.unselectItem(a);
crs.core.toolbar.updateActionbar()
},updateActionbar:function(){var a=$(".list").find(".item-checkbox:checked").length;
if(a==0){crs.core.toolbar.$actionbar.removeClass("multiple-selected single-selected")
}else{if(a==1){crs.core.toolbar.$actionbar.removeClass("multiple-selected").addClass("single-selected")
}else{crs.core.toolbar.$actionbar.removeClass("single-selected").addClass("multiple-selected")
}}},getSelectedItems:function(){return crs.core.toolbar.$dataSourceList.find("li.selected")
},hideOrShowColumns:function(){var b=$(this),a=b.attr("data-target"),c=b.is(":checked");
c?crs.core.toolbar.$ulList.removeClass(a):crs.core.toolbar.$ulList.addClass(a)
}};
$(document).on("change","#select-all-checkbox",crs.core.toolbar.updateAllCheckboxes);
$(document).on("change",".list .item-checkbox",crs.core.toolbar.updateListItemAndActionbar);
crs.core.toolbar.$actionbar.find(".column-name input").change(crs.core.toolbar.hideOrShowColumns)
});
$(function(){var b=null;
var a=$(".searchField");
crs.core.toolbarActions={deleteDataSources:function(d){var c=crs.core.toolbar.getSelectedItems(),e=[];
$.each(c,function(f,g){e.push(g.getAttribute("data-path"))
});
if(e.length!=0){crs.core.toolbarActions.confirmDelete(e.length,function(){crs.core.showLoading();
var g=$("#error-dsList-modal");
var f=$("#success-dsList-modal");
$.ajax({url:crs.core.crsAPIUrl,type:"POST",data:{action:"delete_datasource",paths:JSON.stringify(e),_charset_:"utf-8"}}).done(function(i){var h=i&&i.messages;
if(h&&h.length>0&&h[0].type=="error"){g.show().find(".message").html(h[0].content)
}else{crs.core.toolbarActions.removeElementsFromDOM(c);
f.show().find(".message").html(Granite.I18n.get("Attribute source(s) deleted successfully.",null,"CRS: "))
}}).fail(function(h){console.error("Failed to delete DataSource");
g.show().find(".message").html(Granite.I18n.get("Failed to delete attribute source(s)",null,"CRS: "))
}).always(function(){crs.core.hideLoading();
crs.core.toolbar.updateActionbar()
})
})
}},confirmDelete:function(d,f){var c=$("#confirm-delete-modal");
var e="<p>"+Granite.I18n.get("Deleting this Customer Atrribute Source will not remove any of the associated customer data from system. ","CRS: ")+Granite.I18n.get("It will however delete all the meta data associated with it here.","CRS: ")+"</p><p>"+Granite.I18n.get("If you need to remove data that has already been uploaded into the system, then you need to contact your Adobe representative for assistance.","CRS: ")+"</p>";
c.modal({type:"notice",header:Granite.I18n.get("Confirm Delete",null,"CRS: "),content:e,buttons:[{label:Granite.I18n.get("Cancel",null,"CRS: "),click:"hide"},{label:Granite.I18n.get("Continue",null,"CRS: "),className:"primary",click:function(){this.hide();
typeof f=="function"&&f()
}}]});
c.modal("show")
},removeElementsFromDOM:function(c){c.remove()
},searchDataSources:function(){if(!crs.core.isSearchEnabled){return
}var d=crs.core.crsAPIUrl+".list.html";
var e=a.val(),c=$("ul > li .cell.sortable");
if(!e){c.addClass("sorting-enabled");
crs.core.fetchAllDataSources();
return
}c.removeClass("sorting-enabled");
c.find(".icon").addClass("hidden");
var f={action:"search_datasources",searchText:e,pageno:1,sortOrder:"desc",sortBy:"lastRefreshTime"};
crs.core.showLoading();
crs.core.$dataSourcesList.empty();
$.get(d,f).done(function(g){crs.core.showDataSourcesList(g,true)
}).fail(function(g){console.error(g);
crs.core.showErrorMessage()
}).always(function(){crs.core.hideLoading()
})
}};
crs.core.toolbar.$actionbar.find(".action-delete").on("click",crs.core.toolbarActions.deleteDataSources);
crs.core.toolbar.$actionbar.find("input.searchField").on("keydown",function(c){if(b!=null){clearTimeout(b);
b=null
}if(c.keyCode==13||c.which==13){crs.core.toolbarActions.searchDataSources()
}else{b=setTimeout(crs.core.toolbarActions.searchDataSources,1000)
}});
crs.core.toolbar.$actionbar.find("button.submit").on("click",crs.core.toolbarActions.searchDataSources)
});
$(function(){crs.core.customeragreement={acceptAgreement:function(){var b=$(".customeragreementdata");
var f=b.find(".fullname input");
var e=b.find(".title input");
var a=b.find(".company input");
var c=b.find(".agreementcheckbox");
var d="";
if(!c.attr("checked")){d=Granite.I18n.get("Please accept the agreement to continue",null,"CRS: ");
$("#customeragreement-alert-box").show().find(".message").html(d);
return
}if(crs.core.customeragreement.isEmpty(f.val())||crs.core.customeragreement.isEmpty(a.val())){d=Granite.I18n.get("Either of name or company is empty, please enter the details",null,"CRS: ")
}if(d.length>0){$("#customeragreement-alert-box").show().find(".message").html(d);
return
}$.ajax({url:"/crs/customeragreement/nopii",type:"POST",data:{action:"accept",data:JSON.stringify({name:f.val().trim(),company:a.val().trim(),title:e.val().trim()})}}).done(function(i){var g="";
var h=i&&i.messages;
if(h&&h.length>0&&h[0].type=="error"){$("#error-segmentList-modal").show().find(".message").html(h[0].content);
$vennWaitContainer.addClass("al-hidden")
}else{if(i&&i.response&&i.response.success){g=i.response.success;
if(g===true){window.location.reload()
}else{d=Granite.I18n.get("Some error has occurred, please contact system administrator.",null,"CRS: ");
$("#customeragreement-alert-box").show().find(".message").html(d)
}}}})
},isEmpty:function(a){return a.trim().length<1
}};
$(document).on("click","#accept-agreement",crs.core.customeragreement.acceptAgreement)
});